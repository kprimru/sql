USE [FirstInstall]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [Distr].[DISTR_UPDATE]
	@DH_ID		UNIQUEIDENTIFIER,
	@DS_NUM		INT,
	@DS_COMP	TINYINT,
	@SYS_ID		UNIQUEIDENTIFIER,
	@DT_ID		UNIQUEIDENTIFIER,
	@NT_ID		UNIQUEIDENTIFIER,
	@TT_ID		UNIQUEIDENTIFIER,
	@DH_DATE	SMALLDATETIME
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE @HST_ID UNIQUEIDENTIFIER
	DECLARE @DS_ID UNIQUEIDENTIFIER

	SELECT @HST_ID = SYS_ID_HOST
	FROM Distr.SystemLast
	WHERE SYS_ID_MASTER = @SYS_ID

	SELECT @DS_ID = DH_ID_DISTR
	FROM Distr.DistrHistory
	WHERE DH_ID = @DH_ID

	DECLARE @OLD	VARCHAR(MAX)
	DECLARE @NEW	VARCHAR(MAX)

	EXEC Common.PROTOCOL_VALUE_GET 'DISTR', @DS_ID, @OLD OUTPUT


	UPDATE	Distr.DistrStore
	SET		DS_ID_HOST	=	@HST_ID,
			DS_NUM		=	@DS_NUM,
			DS_COMP		=	@DS_COMP,
			DS_LAST		=	GETDATE()
	WHERE	DS_ID		=	@DS_ID

	UPDATE	Distr.DistrHistory
	SET		DH_ID_SYSTEM	=	@SYS_ID,
			DH_ID_NET		=	@NT_ID,
			DH_ID_TYPE		=	@DT_ID,
			DH_ID_TECH		=	@TT_ID,
			DH_DATE			=	@DH_DATE
	WHERE	DH_ID			=	@DH_ID

	EXEC Common.PROTOCOL_VALUE_GET 'DISTR', @DS_ID, @NEW OUTPUT

	EXEC Common.PROTOCOL_INSERT 'DISTR', 'Редактирование', @DS_ID, @OLD, @NEW

END
GO
GRANT EXECUTE ON [Distr].[DISTR_UPDATE] TO rl_distr_store_u;
GO
