USE [ClientDB]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Subhost].[FILE_DISCOUNT_SELECT]
	@SUBHOST	NVARCHAR(16),
	@USR		NVARCHAR(128)
WITH EXECUTE AS OWNER
AS
BEGIN
	SET NOCOUNT ON;

	IF @SUBHOST <> 'Н1'
	BEGIN
		RAISERROR ('Вашему подхосту недоступен данный отчет', 16, 1)
		RETURN
	END
	
	IF OBJECT_ID('tempdb..#r') IS NOT NULL
		DROP TABLE #r
		
	CREATE TABLE #r
		(
			CL_ID		INT,
			CL_PSEDO	NVARCHAR(128),
			DIS_STR		NVARCHAR(128),
			SST_CAPTION	NVARCHAR(128),
			SN_NAME		NVARCHAR(128),
			DISCOUNT	INT,
			DF_FIXED	MONEY,
			REAL_DISC	DECIMAL(8,4),
			SYS_ORDER	INT,
			DIS_NUM		INT,
			DIS_COMP	TINYINT
		)
		
	INSERT INTO #r
		EXEC [PC275-SQL\DELTA].DBF_NAH.dbo.DISTR_FINANCING_REPORT
	
	SELECT 
		CL_PSEDO AS 'Клиент', DIS_STR AS 'Дистрибутив', SST_CAPTION AS 'Тип системы',
		SN_NAME AS 'Тип сети', DISCOUNT AS 'Скидка', DF_FIXED AS 'Фикс.сумма',
		REAL_DISC AS 'Реальная скидка'
	FROM #r
	ORDER BY CL_PSEDO, SYS_ORDER, DIS_NUM, DIS_COMP
	
	IF OBJECT_ID('tempdb..#r') IS NOT NULL
		DROP TABLE #r
	
	INSERT INTO Subhost.FilesDownload(ID_SUBHOST, USR, FTYPE)
		SELECT SH_ID, @USR, N'DISCOUNT'
		FROM dbo.Subhost
		WHERE SH_REG = @SUBHOST
			AND @USR IS NOT NULL
END
