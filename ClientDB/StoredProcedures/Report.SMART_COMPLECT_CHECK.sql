USE [ClientDB]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [Report].[SMART_COMPLECT_CHECK]
	@PARAM NVARCHAR(MAX) = NULL
AS
BEGIN
	SET NOCOUNT ON;

	SELECT 
		CL_PSEDO AS [Ïñåâäîíèì], CL_FULL_NAME AS [Êëèåíò],
		(
			SELECT 
				dbo.DistrString(SYS_SHORT_NAME, DIS_NUM, DIS_COMP_NUM) + ' (' + 
				CASE RN_TECH_TYPE 
					WHEN 0 THEN
						CASE RN_NET_COUNT
							WHEN 0 THEN 'ëîê'
							WHEN 1 THEN '1/ñ'
							WHEN 5 THEN 'ì/ñ'
							ELSE 'ñåòü'
						END
					WHEN 1 THEN 'ôëýø'
					WHEN 7 THEN 'ÎÂÊ'
					WHEN 3 THEN 'ÎÂÏ'
					WHEN 6 THEN 'ÎÂÏÈ'
					WHEN 9 THEN 'ÎÂÌ'
					WHEN 10 THEN 'ÎÂÊ-Ô'
					WHEN 11 THEN 'ÎÂÌ-Ô'
					ELSE 'Íåèçâåñòíî'
				END
				 + '), '
			FROM 
				[PC275-SQL\DELTA].DBF.dbo.ClientDistrView a
				INNER JOIN [PC275-SQL\DELTA].DBF.dbo.RegNodeView b ON a.SYS_REG_NAME = b.RN_SYS_NAME AND a.DIS_NUM = b.RN_DISTR_NUM AND a.DIS_COMP_NUM = b.RN_COMP_NUM
			WHERE a.CD_ID_CLIENT = z.CL_ID AND b.RN_SERVICE = 0
			ORDER BY RN_TECH_TYPE, SYS_ORDER, DIS_NUM FOR XML PATH('')
		) AS [Äèñòðèáóòèâû],
		(
			SELECT COUR_NAME
			FROM [PC275-SQL\DELTA].DBF.dbo.ClientCourVIew t
			WHERE t.CL_ID = z.CL_ID
		) AS [ÑÈ]
	FROM [PC275-SQL\DELTA].DBF.dbo.ClientTable z
	WHERE EXISTS
		(
			SELECT *
			FROM 
				[PC275-SQL\DELTA].DBF.dbo.ClientDistrView a
				INNER JOIN [PC275-SQL\DELTA].DBF.dbo.RegNodeTable b ON a.SYS_REG_NAME = b.RN_SYS_NAME AND a.DIS_NUM = b.RN_DISTR_NUM AND a.DIS_COMP_NUM = b.RN_COMP_NUM
			WHERE a.CD_ID_CLIENT = z.CL_ID AND b.RN_SERVICE = 0
				AND b.RN_SYS_NAME IN ('BBKZ', 'UBKZ', 'UMKZ')
		) 
		AND NOT EXISTS
		(
			SELECT *
			FROM 
				[PC275-SQL\DELTA].DBF.dbo.ClientDistrView a
				INNER JOIN [PC275-SQL\DELTA].DBF.dbo.RegNodeTable b ON a.SYS_REG_NAME = b.RN_SYS_NAME AND a.DIS_NUM = b.RN_DISTR_NUM AND a.DIS_COMP_NUM = b.RN_COMP_NUM
			WHERE a.CD_ID_CLIENT = z.CL_ID AND b.RN_SERVICE = 0
				AND b.RN_NET_COUNT > 0
				AND b.RN_TECH_TYPE IN (0, 11)
		) 
		--AND CL_ID_ORG = 1
	ORDER BY 4, 1
END
