USE [ClientDB]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[CLIENT_TRUST_PROCESS]
	@CALL	UNIQUEIDENTIFIER,
	@TNAME		BIT,
	@NAME		VARCHAR(500),
	@TADDRESS	BIT,
	@ADDRESS	VARCHAR(500),
	@TDIR		BIT,
	@DIR		VARCHAR(250),
	@TDIR_POS	BIT,
	@DIR_POS	VARCHAR(250),
	@TDIR_PHONE	BIT,
	@DIR_PHONE	VARCHAR(150),
	@TBUH		BIT,
	@BUH		VARCHAR(250),
	@TBUH_POS	BIT,
	@BUH_POS	VARCHAR(250),
	@TBUH_PHONE	BIT,
	@BUH_PHONE	VARCHAR(150),
	@TRES		BIT,
	@RES		VARCHAR(250),
	@TRES_POS	BIT,
	@RES_POS	VARCHAR(150),
	@TRES_PHONE	BIT,
	@RES_PHONE	VARCHAR(150),
	@TRUST		BIT,
	@NOTE		VARCHAR(MAX),
	@ID			UNIQUEIDENTIFIER = NULL OUTPUT
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE
		@DebugError		VarChar(512),
		@DebugContext	Xml,
		@Params			Xml;

	EXEC [Debug].[Execution@Start]
		@Proc_Id		= @@ProcId,
		@Params			= @Params,
		@DebugContext	= @DebugContext OUT

	BEGIN TRY

		DECLARE @CT_ID	UNIQUEIDENTIFIER

		SELECT @CT_ID = CT_ID
		FROM dbo.ClientTrust
		WHERE CT_ID_CALL = @CALL

		IF @CT_ID IS NULL
			EXEC dbo.CLIENT_TRUST_INSERT @CALL, @TNAME, @NAME, @TADDRESS, @ADDRESS, @TDIR, @DIR, @TDIR_POS, @DIR_POS, @TDIR_PHONE, @DIR_PHONE, @TBUH, @BUH, @TBUH_POS, @BUH_POS, @TBUH_PHONE, @BUH_PHONE, @TRES, @RES, @TRES_POS, @RES_POS, @TRES_PHONE, @RES_PHONE, @TRUST, @NOTE, @ID OUTPUT
		ELSE
			EXEC dbo.CLIENT_TRUST_UPDATE @CALL, @TNAME, @NAME, @TADDRESS, @ADDRESS, @TDIR, @DIR, @TDIR_POS, @DIR_POS, @TDIR_PHONE, @DIR_PHONE, @TBUH, @BUH, @TBUH_POS, @BUH_POS, @TBUH_PHONE, @BUH_PHONE, @TRES, @RES, @TRES_POS, @RES_POS, @TRES_PHONE, @RES_PHONE, @TRUST, @NOTE

		EXEC [Debug].[Execution@Finish] @DebugContext = @DebugContext, @Error = NULL;
	END TRY
	BEGIN CATCH
		SET @DebugError = Error_Message();

		EXEC [Debug].[Execution@Finish] @DebugContext = @DebugContext, @Error = @DebugError;

		EXEC [Maintenance].[ReRaise Error];
	END CATCH
END
GRANT EXECUTE ON [dbo].[CLIENT_TRUST_PROCESS] TO rl_client_call_i;
GRANT EXECUTE ON [dbo].[CLIENT_TRUST_PROCESS] TO rl_client_call_u;
GO